From a0ce16d1c52a741abb1e40e209d82658c342dc66 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?J=C3=B6rg=20Thalheim?= <joerg@thalheim.io>
Date: Sat, 24 Jan 2026 06:53:56 +0100
Subject: [PATCH] migrateLinksTable: Fix categorylinks migration with literal
 namespace
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

The categorylinks table mapping uses a literal integer (14 = NS_CATEGORY)
for the 'ns' field instead of a column name. This causes migrateLinksTable.php
to fail with:
- "Undefined array key 14" when trying to fetch $row[14]
- SQL syntax error "AND () AND" when building the WHERE clause

Handle the case where the namespace mapping is a literal integer rather
than a column name by:
1. Not selecting it as a column (it doesn't exist)
2. Using the literal value directly for the namespace
3. Not adding a namespace condition to the WHERE clause (unnecessary
   since categorylinks only contains NS_CATEGORY entries)

Signed-off-by: JÃ¶rg Thalheim <joerg@thalheim.io>
---
 maintenance/migrateLinksTable.php | 30 +++++++++++++++++++++---------
 1 file changed, 21 insertions(+), 9 deletions(-)

diff --git a/maintenance/migrateLinksTable.php b/maintenance/migrateLinksTable.php
index c7bcc0436e4..2bcaba592ad 100644
--- a/maintenance/migrateLinksTable.php
+++ b/maintenance/migrateLinksTable.php
@@ -104,9 +104,17 @@ class MigrateLinksTable extends LoggedUpdateMaintenance {
 		$highPageId = $lowPageId + $batchSize - 1;
 		$dbw = $this->getPrimaryDB();
 
+		// For categorylinks, the 'ns' mapping is a literal integer (14 = NS_CATEGORY)
+		// rather than a column name, so we need to handle it specially
+		$nsField = $mapping[$table]['ns'];
+		$nsIsLiteral = is_int( $nsField );
+		$selectFields = $nsIsLiteral
+			? [ $mapping[$table]['title'] ]
+			: [ $nsField, $mapping[$table]['title'] ];
+
 		while ( true ) {
 			$res = $dbw->newSelectQueryBuilder()
-				->select( [ $mapping[$table]['ns'], $mapping[$table]['title'] ] )
+				->select( $selectFields )
 				->from( $table )
 				->where( [
 					$targetColumn => [ null, 0 ],
@@ -120,20 +128,24 @@ class MigrateLinksTable extends LoggedUpdateMaintenance {
 				break;
 			}
 			$row = $res->fetchRow();
-			$ns = $row[$mapping[$table]['ns']];
+			// Use the literal namespace value for categorylinks, otherwise fetch from row
+			$ns = $nsIsLiteral ? $nsField : $row[$nsField];
 			$titleString = $row[$mapping[$table]['title']];
 			$title = new TitleValue( (int)$ns, $titleString );
 			$id = $this->getServiceContainer()->getLinkTargetLookup()->acquireLinkTargetId( $title, $dbw );
+			$whereConditions = [
+				$targetColumn => [ null, 0 ],
+				$mapping[$table]['title'] => $titleString,
+				$dbw->expr( $pageIdColumn, '>=', $lowPageId ),
+				$dbw->expr( $pageIdColumn, '<=', $highPageId ),
+			];
+			if ( !$nsIsLiteral ) {
+				$whereConditions[$nsField] = $ns;
+			}
 			$dbw->newUpdateQueryBuilder()
 				->update( $table )
 				->set( [ $targetColumn => $id ] )
-				->where( [
-					$targetColumn => [ null, 0 ],
-					$mapping[$table]['ns'] => $ns,
-					$mapping[$table]['title'] => $titleString,
-					$dbw->expr( $pageIdColumn, '>=', $lowPageId ),
-					$dbw->expr( $pageIdColumn, '<=', $highPageId ),
-				] )
+				->where( $whereConditions )
 				->caller( __METHOD__ )->execute();
 			$this->updateProgress( $dbw->affectedRows(), $lowPageId, $highPageId, $ns, $titleString );
 		}
-- 
2.52.0

